---
date:
  created: 2025-11-28

---

# **üìÖ SAISON B Semaine 4 √âpisode 5 - Projet en autonomie Jour 3 - Base de Donn√©es, Gestion des Erreurs et Style**

## **üìö Introduction**

Troisi√®me jour de travail sur le projet **oCoffee** ! Aujourd‚Äôhui, j‚Äôai franchi une √©tape majeure en **cr√©ant et connectant la base de donn√©es PostgreSQL**, en **dynamisant enti√®rement les pages** avec les donn√©es de la base, et en **am√©liorant l‚Äôexp√©rience utilisateur** avec une page 404 personnalis√©e et un design responsive. Voici le d√©tail de cette journ√©e bien remplie.

!!! Note D√©p√¥t Github
    Le d√©p√¥t Github du projet est disponible [ici](https://github.com/YoannMis/oCoffee).

<!-- more -->

---

## **√âtape 1 : Cr√©ation de la Base de Donn√©es PostgreSQL**

### **Contexte**

Hier, j‚Äôavais pr√©par√© un fichier JSON pour simuler une base de donn√©es. Aujourd‚Äôhui, j‚Äôai **cr√©√© la base de donn√©es PostgreSQL** pour stocker les donn√©es de mani√®re permanente.

### **Actions r√©alis√©es**

1. **Cr√©ation du script SQL** (`data/create_db.sql`) :
    Ce script contient les requ√™tes pour cr√©er les tables `COUNTRIES`, `COFFEE_ATTRIBUTES`, `COFFEES`, et `COFFEES_HAVE_COUNTRIES`, bas√©es sur le mod√®le que j‚Äôavais con√ßu [le jour 1 du projet](https://yoannmis.github.io/my-journey/blog/2025/11/26/-saison-b-semaine-4-%C3%A9pisode-3---projet-en-autonomie---ocoffee/#etape-3-transformation-du-mcd-en-mld).

    Exemple de cr√©ation de table :

    ```sql
    CREATE TABLE COUNTRIES (
        country_id SERIAL PRIMARY KEY,
        name VARCHAR(100) NOT NULL
    );

    CREATE TABLE COFFEES (
        coffee_ref SERIAL PRIMARY KEY,
        coffee_name VARCHAR(100) NOT NULL,
        image VARCHAR(255),
        price DECIMAL(6, 2) NOT NULL,
        availability BOOLEAN DEFAULT TRUE,
        attribute_id INT REFERENCES COFFEE_ATTRIBUTES(attribute_id),
        country_id INT REFERENCES COUNTRIES(country_id)
    );
    ```

    Voir le script complet sur [mon d√©p√¥t Github](https://github.com/YoannMis/oCoffee/blob/main/data/create-db.sql).

2. **Cr√©ation de la Base De Donn√©es et ex√©cution du script** :

    + J‚Äôai cr√©√© la base de donn√©es `ocoffee` dans `psql` :

      ```bash
      CREATE DATABASE ocoffe OWNER ocoffee;
      ```

    + Puis j‚Äôai ex√©cut√© le script SQL pour cr√©er les tables :

      ```bash
      psql -U ocoffee -d ocoffee -f data/create_db.sql
      ```

---

## **√âtape 2 : Connexion √† la Base de Donn√©es et R√©cup√©ration des Donn√©es**

### **Contexte**

J‚Äôai remplac√© la logique de r√©cup√©ration des donn√©es depuis le fichier JSON par des **requ√™tes SQL** pour interagir avec la base de donn√©es PostgreSQL.

### **Actions r√©alis√©es**

1. **Configuration de la connexion √† la base de donn√©es** (`src/models/databaseClient.js`) :
    J‚Äôai utilis√© le module `pg` pour √©tablir une connexion s√©curis√©e √† la base de donn√©es.

    ```javascript title="src/models/databaseClient.js"
    /**
    * Database client module
    *
    * This module initializes and exports a PostgreSQL client instance using the 'pg' library.
    * The connection string is retrieved from the POSTGRES_CONNECTION_STRING environment variable.
    * The client is connected immediately upon import.
    *
    * @module databaseClient
    */

    import { Client } from 'pg';


    /**
    * The PostgreSQL client instance.
    *
    * @type {Client}
    */
    const client = new Client(process.env.POSTGRES_CONNECTION_STRING);


    // Connect to the PostgreSQL database
    client.connect();


    /**
    * Exports the connected PostgreSQL client for use in other modules.
    */
    export default client;
    ```

2. **Cr√©ation d‚Äôun DataMapper** (`src/models/coffee.dataMapper.js`) :
    Ce fichier contient les fonctions pour interagir avec la table `COFFEES`.

    ```javascript title="src/models/coffee.dataMapper.js"
    // Import the PostgreSQL client instance
    import client from './databaseClient.js';

    /**
    * Coffee data mapper module
    *
    * Provides methods to interact with the 'coffees' table in the database.
    * @module models/coffeeDataMapper
    */
    export default {
      /**
      * Retrieve the three latest coffees from the database.
      *
      * @async
      * @function getThreeLatestCoffees
      * @returns {Promise<Array<Object>>} Array of the three latest coffee objects (reference, name, image)
      */
      async getThreeLatestCoffees() {
        // SQL query to select the three most recent coffees by reference
        const selectCoffeesQuery = `
          SELECT c.coffee_ref, c.coffee_name, c.image
          FROM coffees c
          ORDER BY c.coffee_ref DESC
          LIMIT 3
        `;

        const result = await client.query(selectCoffeesQuery);
        return result.rows;
      },
      // other functions...
    };
    ```

    Voir les modifications compl√®tes sur [mon d√©p√¥t Github](https://github.com/YoannMis/oCoffee/blob/main/src/models/coffee.dataMapper.js).

3. **Modification des contr√¥leurs** :
    J‚Äôai mis √† jour les contr√¥leurs pour utiliser le `CoffeeDataMapper` au lieu du fichier JSON.

    Exemple avec `catalog.controller.js` :

    ```javascript title="src/models/coffee.dataMapper.js"
    // Import the data mapper for database operations related to coffee
    import coffeeDataMapper from '../models/coffee.dataMapper.js';

    /**
    * Controller for handling catalog page logic.
    * @module controllers/catalogController
    */
    /**
    * Catalog controller object containing methods for rendering catalog and coffee details pages.
    */
    export default {
      /**
      * Render the catalog page with all coffees from the database.
      *
      * This method fetches all coffee entries using the data mapper and renders the 'catalog' view,
      * passing the coffees as data to the template.
      *
      * @async
      * @function displayCatalog
      * @param {import('express').Request} req - Express request object
      * @param {import('express').Response} res - Express response object
      */
      async displayCatalog(req, res) {
        try {
          // Fetch all coffees from the database
          const coffees = await coffeeDataMapper.getAllCoffees();
          // Render the catalog page with the list of coffees
          res.render('catalog', { coffees });
        } catch(error) {
          // Log the error and render a 500 error page
          console.log(error.message);
          res.status(500).render('error/500');
        }
      },
      // other functions...
    };
    ```

    Voir les modifications compl√®tes sur [mon d√©p√¥t Github](https://github.com/YoannMis/oCoffee/tree/main/src/controllers).

---

## **√âtape 3 : Gestion des Erreurs 404 et 500**

### **Contexte**

Pour am√©liorer l‚Äôexp√©rience utilisateur, j‚Äôai ajout√© une **page 404 personnalis√©e** et une gestion des erreurs 500.

### **Actions r√©alis√©es**

1. **Cr√©ation d‚Äôune vue pour la page 404** (`views/404.ejs`) :

   Une page avec une illustration de tasse de caf√© renvers√©e et des liens utiles.

   ![page erreur 404](../../../../assets/sb04e05/404.png)

2. **Gestion des erreurs 500** :

    J‚Äôai cr√©√© une vue `views/500.ejs`.

3. **Ajout de `try...catch` dans les contr√¥leurs** :

    Pour g√©rer les erreurs j'ai ajout√© une instruction `try...catch` dans les functions des controllers.

    Exemple dans le `catalog.controller.js` :

    ```javascript title="Error 500 handling - src/controllers/catalog.controller.js" hl_lines="7-11"
    async displayCatalog(req, res) {
      try {
        // Fetch all coffees from the database
        const coffees = await coffeeDataMapper.getAllCoffees();
        // Render the catalog page with the list of coffees
        res.render('catalog', { coffees });
      } catch(error) {
        // Log the error and render a 500 error page
        console.log(error.message);
        res.status(500).render('error/500');
      }
    }
    ```

---

## **√âtape 4 : Stylisation des Pages et Responsive Design**

### **Contexte**

J‚Äôai travaill√© sur le **style CSS** des nouvelles vues (`coffee-details.ejs` et `shop.ejs`) et rendu l‚Äôapplication **responsive** pour les appareils mobiles.

### **Actions r√©alis√©es**

1. **Cr√©ation de fichiers CSS d√©di√©s** :

    + `public/css/coffee-details.css` pour la page de d√©tail d‚Äôun caf√©.
    + `public/css/shop.css` pour la page de pr√©sentation de la boutique.

2. **Rendu** :

    D√©tail d'un caf√© :

    ![d√©tail caf√©](../../../../assets/sb04e05/coffee-details.png)

    Boutique :

    ![page boutique](../../../../assets/sb04e05/shop.png)

---

## **Bilan de la Journ√©e**

### **Ce qui a bien fonctionn√©**

‚úÖ **Base de donn√©es PostgreSQL** : Cr√©√©e et connect√©e avec succ√®s.  
‚úÖ **Dynamisation des pages** : Les donn√©es sont maintenant r√©cup√©r√©es depuis la base.  
‚úÖ **Gestion des erreurs** : Pages 404 et 500 personnalis√©es et fonctionnelles.  
‚úÖ **Responsive Design** : L‚Äôapplication s‚Äôaffiche correctement sur mobile.  

### **Difficult√©s rencontr√©es**

Pas de difficult√©s majeurs.

---

## **Prochaines √âtapes et Fonctionnalit√©s Futures**

Pour aller plus loin, j‚Äôaimerais ajouter :

+ **Une carte interactive** dans la page `shop.ejs` pour indiquer l‚Äôemplacement de la boutique (avec Leaflet et OpenStreetMap).
+ **Un formulaire de contact** qui envoie un email de confirmation (avec EmailJS).
+ **Une page d‚Äôadministration** pour ajouter de nouveaux caf√©s.
+ **D√©ployer l‚Äôapplication** sur un PaaS comme *Render*.

---

## **Conclusion**

Cette troisi√®me journ√©e a √©t√© **tr√®s enrichissante** et m'a permis de voir en d√©tail la gestion d'une base de donn√©es.

Ce projet challenge √©tait vraiment sympa √† r√©aliser. Dommage que je n'avais pas plus de temps pour ajouter d'autres fonctionnalit√©s int√©ressantes (que j'essaierai d'ajouter plus tard). J'ai perdu un peu de temps sur des erreurs b√™tes mais c'est comme √ßa qu'on apprend. C'est le m√©tier qui rentre üòÄ.
