---
date:
  created: 2025-12-04

---

# **üìÖ SAISON B Semaine 5 √âpisode 4 - Ma√Ætrise de Sequelize**

## **üìö Notions du jour**

Aujourd‚Äôhui, nous avons approfondi notre utilisation de **Sequelize**, l‚ÄôORM (Object-Relational Mapping) pour Node.js, en explorant des concepts **cl√©s** pour construire une application robuste. Apr√®s avoir configur√© Sequelize et test√© la connexion √† la base de donn√©es, nous passons maintenant √† la **d√©finition des mod√®les**, la **gestion des associations**, et l‚Äô**impl√©mentation compl√®te du CRUD** (Create, Read, Update, Delete).

Dans cet article, nous allons couvrir :

+ **La d√©finition des mod√®les** avec `sequelize.define()` et les `DataTypes`.
+ **La synchronisation du sch√©ma** avec `sequelize.sync()`.
+ **Les associations entre mod√®les** (`belongsTo`, `hasMany`, `belongsToMany`).
+ **Le chargement des donn√©es associ√©es** avec l‚Äôoption `include`.
+ **Le peuplement de la base de donn√©es** (seeding).
+ **Le remplacement de notre couche d‚Äôacc√®s manuelle** par les m√©thodes de Sequelize.

<!-- more -->

---

### **üìö D√©finition des Mod√®les avec `sequelize.define()` et `DataTypes`**

Un **mod√®le** dans Sequelize repr√©sente une **table** dans la base de donn√©es. Chaque mod√®le est d√©fini avec des **colonnes** (attributs) et des **types de donn√©es** (`DataTypes`).

Pour rappel nous avons d√©j√† d√©fini notre *Model* `Coffee` en cours hier ainsi que le *Model* `Country` lors du challenge (voir [üìÖ SAISON B Semaine 5 √âpisode 3 - Introduction aux ORM](./sb05e03.md)).

Sur la m√™me base nous avons d√©fini un dernier *Model* `Category`.

### **üîó Associations entre Mod√®les**

Pour **centraliser et organiser** les relations entre nos mod√®les, nous cr√©ons un fichier `index.js` dans le dossier `src/models/`. Ce fichier importe tous les mod√®les et d√©finit leurs **associations**.

---

#### **Centralisation des Mod√®les et D√©finition des Associations**

**Exemple : Fichier `src/models/index.js`**

```javascript title="src/models/index.js"
// Import all models
import Country from "./Country.js";
import Category from "./Category.js";
import Coffee from "./Coffee.js";

// One-to-Many / Many-to-One Relationship
// A country has many coffees
Country.hasMany(Coffee, {
  foreignKey: 'country_id', // Foreign key in the Coffee table
  as: 'coffees'             // Alias for inclusion (join)
});

// A coffee belongs to one country
Coffee.belongsTo(Country, {
  foreignKey: 'country_id', // Foreign key in the Coffee table
  as: 'country'             // Alias for inclusion (join)
});

// Many-to-Many Relationship
// A coffee can have multiple categories
Coffee.belongsToMany(Category, {
  through: 'coffee_category', // Junction table name
  // Be careful not to reverse foreignKey and otherKey.
  // foreignKey must be different from the called model!
  foreignKey: 'coffee_id',  // Foreign key in the junction table (points to Coffee)
  otherKey: 'category_id',   // Other key in the junction table (points to Category)
  as: 'categories'           // Alias for inclusion (join)
});

// A category can have multiple coffees
Category.belongsToMany(Coffee, {
  through: 'coffee_category', // Junction table name
  // Be careful not to reverse foreignKey and otherKey.
  // foreignKey must be different from the called model!
  foreignKey: 'category_id', // Foreign key in the junction table (points to Category)
  otherKey: 'coffee_id',     // Other key in the junction table (points to Coffee)
  as: 'coffees'              // Alias for inclusion (join)
});

// Export all models
export { Country, Category, Coffee };
```

**Explications :**

+ **`hasMany` et `belongsTo`** : D√©finissent une relation **1:N** (un pays a plusieurs caf√©s, un caf√© appartient √† un pays).
  + **`foreignKey`** : Sp√©cifie la cl√© √©trang√®re dans la table li√©e.
  + **`as`** : D√©finit un alias pour les requ√™tes avec `include`.
+ **`belongsToMany`** : D√©finit une relation **N:N** (un caf√© peut avoir plusieurs cat√©gories, une cat√©gorie peut √™tre associ√©e √† plusieurs caf√©s).
  + **`through`** : Sp√©cifie le nom de la **table de liaison** (`coffee_category`).
  + **`foreignKey` et `otherKey`** : D√©finissent les cl√©s √©trang√®res dans la table de liaison.
    + **`foreignKey`** : Pointe vers le mod√®le **appelant** (ex: `Coffee` pour `Coffee.belongsToMany`).
    + **`otherKey`** : Pointe vers le mod√®le **cible** (ex: `Category` pour `Coffee.belongsToMany`).

---

#### **üí° Points Cl√©s sur les Associations**

1. **Centralisation** : Le fichier `index.js` regroupe toutes les d√©finitions d‚Äôassociations, ce qui rend le code **plus organis√© et maintenable**.
2. **Cl√©s √âtrang√®res** : Les relations **1:N** utilisent une cl√© √©trang√®re dans la table "N" (ex: `country_id` dans `Coffee`).
3. **Tables de Liaison** : Les relations **N:N** n√©cessitent une **table interm√©diaire** (`through`) avec deux cl√©s √©trang√®res.
4. **Alias (`as`)** : Permettent de **nommer clairement les associations** dans les requ√™tes, ce qui am√©liore la lisibilit√©.

---

### **üîÑ Synchronisation du Sch√©ma avec `sequelize.sync()`**

La synchronisation permet de **cr√©er ou mettre √† jour les tables** dans la base de donn√©es en fonction des mod√®les d√©finis.

#### **Exemple : Synchroniser Tous les Mod√®les**

```javascript title="database/sync.js"
import sequelize from "./sequelize-client.js";

// IMPORTANT: import all models here
import "../src/models/sequelize/index.js"; 

async function syncDb() {
  try {
    // The `{ alter: true }` option compares the state of the database with the Sequelize models.
    // Warning, this is useful in development but dangerous in production
    await sequelize.sync({ alter: true });
    console.log('Database synchronised OK');
  } catch (error) {
    console.error('Database synchronised NOT OK', error);
  } finally {
    sequelize.close();
  }
}

syncDb(); // Call the function to sync models
```

**Explications :**

+ **`sequelize.sync()`** : Cr√©e les tables si elles n‚Äôexistent pas.
  + **`{ alter: true }`** : Met √† jour la structure des tables si le mod√®le a chang√© (attention en production !).
  + **`{ force: true }`** : **Supprime et recr√©e** les tables (√† utiliser avec prudence).

---

### **üå± Peuplement de la Base de Donn√©es (Seeding)**

Le **seeding** (ou peuplement) consiste √† **remplir la base de donn√©es** avec des donn√©es initiales, souvent utilis√©es pour :

+ **Initialiser un environnement de d√©veloppement** avec des donn√©es r√©alistes.
+ **Tester des fonctionnalit√©s** sans avoir √† saisir manuellement des donn√©es.
+ **Cr√©er des jeux de donn√©es** pour des d√©monstrations ou des tests automatis√©s.

Dans notre projet **oCoffee**, nous utilisons un fichier JSON (`ocoffee-dataset.json`) contenant des donn√©es pour les **pays**, **cat√©gories** et **caf√©s**. Voici comment nous proc√©dons pour peupler la base de donn√©es avec Sequelize.

---

#### **1Ô∏è‚É£ Script de Seeding Complet**

**Exemple : Fichier `seed.js`**

```javascript title="database/seed.js"
// Import Sequelize instance and models
import sequelize from "./sequelize-client.js";
import { Country, Category, Coffee } from "../src/models/index.js";
// Import dataset from JSON file
import data from "../data/ocoffee-dataset.json" with { type: "json" };

// Main seeding function
async function seed() {
  // Drop all tables and recreate them (force: true)
  // WARNING: This will delete ALL existing data in the database!
  await sequelize.sync({ force: true, logging: false });

  // Create all countries from the dataset
  const countries = await Country.bulkCreate(data.countries, { returning: true });

  // Create all categories from the dataset
  const categories = await Category.bulkCreate(data.categories, { returning: true });

  // Loop through each coffee in the dataset
  for (const coffeeData of data.coffees) {
    // Create a coffee with its associated country
    // Find the country ID by matching the country name
    const coffee = await Coffee.create({
      ...coffeeData, // Spread all coffee properties
      country_id: countries.find(country => country.dataValues.name === coffeeData.country).id
    });

    // Find categories associated with the coffee in the dataset
    const categoriesToAdd = categories.filter(category =>
      coffeeData.categories.includes(category.dataValues.name)
    );

    // Associate categories with the coffee using Sequelize's magic method `addBar()`
    await coffee.addCategories(categoriesToAdd);

    // Load the country association (optional, for verification)
    await coffee.getCountry();
  }

  // Close the database connection
  await sequelize.close();
  console.log("Database seeding completed successfully!");
}

// Execute the seeding function
seed().catch(error => {
  console.error("Error during seeding:", error);
});
```

---

#### **2Ô∏è‚É£ Explications D√©tail√©es**

1. **`sequelize.sync({ force: true, logging: false })`**
   + **`force: true`** : Supprime et recr√©e **toutes les tables** de la base de donn√©es.
   + **`logging: false`** : D√©sactive les logs SQL pour √©viter la pollution de la console.

2. **`Country.bulkCreate(data.countries, { returning: true })`**
   + **`bulkCreate`** : Cr√©e plusieurs enregistrements en une seule requ√™te (optimis√© pour les performances).
   + **`returning: true`** : Retourne les instances cr√©√©es (utile pour r√©cup√©rer les IDs g√©n√©r√©s).

3. **Cr√©ation des Caf√©s avec leurs Pays Associ√©s**

   ```javascript
   const coffee = await Coffee.create({
     ...coffeeData, // Copy all properties from the dataset
     country_id: countries.find(country => country.dataValues.name === coffeeData.country).id
   });
   ```

   + **`...coffeeData`** : Copie toutes les propri√©t√©s du caf√© depuis le JSON.
   + **`country_id`** : Trouve l‚ÄôID du pays correspondant au nom dans le dataset.

4. **Association des Cat√©gories aux Caf√©s**

   ```javascript
   const categoriesToAdd = categories.filter(category =>
     coffeeData.categories.includes(category.dataValues.name)
   );
   await coffee.addCategories(categoriesToAdd);
   ```

   + **`categories.filter(...)`** : Filtre les cat√©gories pour ne garder que celles associ√©es au caf√©.
   + **`coffee.addCategories(...)`** : M√©thode magique de Sequelize pour cr√©er des associations N:N.

5. **Chargement des Associations (Optionnel)**

   ```javascript
   await coffee.getCountry(); // Load the associated country
   ```

   + **`getCountry()`** : Charge le pays associ√© pour v√©rification (optionnel).

6. **Fermeture de la Connexion**

   ```javascript
   await sequelize.close();
   ```

   + **`sequelize.close()`** : Ferme proprement la connexion √† la base de donn√©es apr√®s le seeding.

---

#### **3Ô∏è‚É£ Structure du Fichier JSON (`ocoffee-dataset.json`)**

Le fichier JSON contient les donn√©es initiales pour les **pays**, **cat√©gories** et **caf√©s**. Voici un exemple de structure :

```json title="data/ocoffee-dataset.json"
{
  "countries": [
    { "name": "Colombia" },
    { "name": "Brazil" },
    { "name": "Ethiopia" }
  ],
  "categories": [
    { "name": "Bio" },
    { "name": "Fair Trade" },
    { "name": "Organic" }
  ],
  "coffees": [
    {
      "name": "Colombian Supreme",
      "price": 8.99,
      "description": "A rich and balanced coffee from Colombia.",
      "country": "Colombia",
      "categories": ["Bio", "Fair Trade"]
    },
    {
      "name": "Brazilian Santos",
      "price": 7.99,
      "description": "A smooth and nutty coffee from Brazil.",
      "country": "Brazil",
      "categories": ["Organic"]
    }
  ]
}
```

---

#### **4Ô∏è‚É£ Points Cl√©s du Seeding**

1. **Efficacit√©** : `bulkCreate` est bien plus rapide que de cr√©er les enregistrements un par un.
2. **Associations** : Sequelize fournit des m√©thodes magiques comme `addCategories` pour g√©rer les relations N:N.
3. **Flexibilit√©** : Le seeding peut √™tre adapt√© pour **importer des donn√©es depuis un fichier**, une API, ou m√™me g√©n√©r√©es al√©atoirement.
4. **Prudence** : **`force: true` supprime toutes les donn√©es existantes** ‚Äì √† utiliser uniquement en d√©veloppement ou en test !

---

### **üîÑ Remplacement de la Couche d‚ÄôAcc√®s Manuelle par Sequelize**

Avant Sequelize, nous utilisions un **datamapper manuel** pour interagir avec la base de donn√©es. Maintenant, nous pouvons **remplacer ces m√©thodes** par des appels Sequelize. Il ne sera plus n√©cessaire de taper des requ√™tes SQL dans notre code.

Nous allons pratiquer dans le [challenge du jour](#challenge-du-jour-projet-ocoffee-projet-fil-rouge-suite) üòä.

---

### **üí° Ce Que J‚Äôai Appris Aujourd‚Äôhui**

1. **Les mod√®les Sequelize** permettent de **d√©finir des tables** et leurs colonnes avec des types de donn√©es et des validations.
2. **Les associations** (`belongsTo`, `hasMany`, `belongsToMany`) simplifient la gestion des relations entre tables.
3. **L‚Äôoption `include`** permet de charger des donn√©es associ√©es en une seule requ√™te (jointure).
4. **Le seeding** est utile pour **peupler la base de donn√©es** avec des donn√©es initiales.
5. **Sequelize remplace avantageusement** les requ√™tes SQL manuelles, ce qui rend le code **plus lisible et maintenable**.

---

## **‚å®Ô∏è Challenge du jour : "Projet oCoffee" ‚Äì projet fil rouge (suite)**

---

### **‚òïÔ∏è Pr√©sentation du Challenge**

Aujourd‚Äôhui, l‚Äôobjectif √©tait de **finaliser l‚Äôint√©gration de Sequelize** dans notre projet **oCoffee** en **rempla√ßant compl√®tement** notre ancien syst√®me de datamapper manuel. Apr√®s avoir d√©fini nos mod√®les et leurs associations, il √©tait temps de **brancher Sequelize directement dans nos contr√¥leurs** pour que l‚Äôapplication utilise pleinement les fonctionnalit√©s de l‚ÄôORM.

**Pourquoi ?**

+ **Supprimer la duplication de code** : Plus besoin d‚Äô√©crire des requ√™tes SQL manuelles.
+ **Am√©liorer la maintenabilit√©** : Le code devient plus lisible et plus facile √† modifier.
+ **Profiter des fonctionnalit√©s de Sequelize** : Jointures, validations, et gestion des associations sans effort.

---

### **üìå √âtapes √† R√©aliser**

---

#### **1Ô∏è‚É£ Supprimer l‚ÄôAncien Datamapper et les Mod√®les Manuels**

J'ai commenc√© par supprimer le datamapper et tous les Mod√®les de class cr√©√©s dans la premi√®re version POO de l'application.

---

#### **2Ô∏è‚É£ Importer les Mod√®les Sequelize dans `ProductController.js`**

**Objectif :** Pr√©parer le contr√¥leur pour utiliser les mod√®les Sequelize.

**Mon code :**

```javascript title="src/controllers/ProductController.js"
import { Coffee, Category, Country } from '../models/index.js';
```

---

#### **3Ô∏è‚É£ R√©√©crire la M√©thode `renderHomePage`**

**Objectif :** R√©cup√©rer les **3 derniers caf√©s** avec Sequelize.

**Mon code :**

```javascript title="src/controllers/ProductController.js"
import CoreController from "./CoreController.js";
import { Country, Category, Coffee } from "../models/Index.js"

class ProductController extends CoreController {
  renderHomePage = async (req, res) => {
    try {
        // Fetch the 3 most recent coffees, ordered by creation date (descending)
        const articles = await Coffee.findAll({
        attributes: ['reference', 'name', 'id'], // Only select specific columns
        order: [['created_at', 'DESC']], // Sort by creation date (newest first)
        limit: 3, // Limit to 3 results
        });
        res.render("pages/home", { articles }); // Render the home page with articles
    } catch (error) {
        console.error(error);
        res.status(500).render("pages/error"); // Render error page on failure
    }
  };
}

export default new ProductController;
```

**Explications :**

+ **`findAll()`** : M√©thode Sequelize pour r√©cup√©rer plusieurs enregistrements.
+ **`attributes: ['reference', 'name', 'id']`** : S√©lectionne uniquement les colonnes n√©cessaires pour optimiser la requ√™te.
+ **`order: [['created_at', 'DESC']]`** : Trie les r√©sultats par date de cr√©ation (du plus r√©cent au plus ancien).
+ **`limit: 3`** : Limite le nombre de r√©sultats √† 3 (pour la page d‚Äôaccueil).

---

#### **4Ô∏è‚É£ R√©√©crire la M√©thode `renderCatalogPage`**

**Objectif :** R√©cup√©rer **tous les caf√©s** et **toutes les cat√©gories** pour la page catalogue.

**Mon code :**

```javascript title="src/controllers/ProductController.js"
// ... Previous code...
renderCatalogPage = async (req, res) => {
  try {
    // Fetch all available coffees, including their associated country
    const articles = await Coffee.findAll({
      include: ['country'], // Include the associated country
      where: {
        available: true, // Only fetch available coffees
      }
    });

    // Fetch all categories for the catalog filters
    const categories = await Category.findAll();

    // Render the catalog page with coffees and categories
    res.render("pages/catalog", { articles, categories });
  } catch (error) {
    console.error(error);
    res.status(500).render("pages/error"); // Render error page on failure
  }
};
```

**Explications :**

+ **`include: ['country']`** : Charge le pays associ√© √† chaque caf√© (relation 1:N).
+ **`where: { available: true }`** : Filtre pour ne r√©cup√©rer que les caf√©s disponibles.
+ **`Category.findAll()`** : R√©cup√®re toutes les cat√©gories pour les filtres du catalogue.

---

#### **5Ô∏è‚É£ R√©√©crire la M√©thode `renderCoffeeDetailsPage`**

**Objectif :** R√©cup√©rer un **caf√© sp√©cifique** avec ses **donn√©es associ√©es** (pays et cat√©gories).

**Mon code :**

```javascript title="src/controllers/ProductController.js"
renderCoffeeDetailsPage = async (req, res, next) => {
  try {
    // Parse the coffee ID from the URL parameters
    const articleId = parseInt(req.params.id);

    // Check if the ID is a valid number
    if (isNaN(articleId)) {
      return next(); // Pass to the next middleware (e.g., 404 handler)
    }

    // Fetch the coffee by ID, including its country and categories
    const article = await Coffee.findByPk(articleId, {
      include: [
        {
          model: Country,
          as: 'country',
          attributes: ['name'] // Only fetch the country name
        },
        {
          model: Category,
          as: 'categories',
          attributes: ['name'] // Only fetch the category names
        }
      ]
    });

    // If the coffee doesn't exist, render a 404 page
    if (!article) {
      return this.render404(req, res); // Use inherited method from CoreController
    }

    // Render the coffee details page with the article data
    res.render("pages/article", { article });
  } catch (error) {
    console.error(error);
    res.status(500).render("pages/error"); // Render error page on failure
  }
};
```

**Explications :**

+ **`findByPk()`** : R√©cup√®re un caf√© par sa cl√© primaire (`id`).
+ **`include`** : Charge les donn√©es associ√©es :
    + **`Country`** : Le pays du caf√© (alias `country`).
    + **`Category`** : Les cat√©gories du caf√© (alias `categories`).
+ **`attributes: ['name']`** : Ne r√©cup√®re que le nom du pays et des cat√©gories (optimisation).

---

### **üí° Ce Que J‚Äôai Appris avec ce Challenge**

1. **Sequelize simplifie grandement** l‚Äôacc√®s aux donn√©es en rempla√ßant les requ√™tes SQL manuelles par des m√©thodes JavaScript.
2. **Les jointures avec `include`** permettent de charger les donn√©es associ√©es en une seule requ√™te.
3. **L‚Äôoptimisation des requ√™tes** avec `attributes` r√©duit la quantit√© de donn√©es inutiles r√©cup√©r√©es.
4. **La refactorisation progressive** permet de migrer vers un ORM sans casser l‚Äôapplication existante.
