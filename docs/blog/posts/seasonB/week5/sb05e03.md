---
date:
  created: 2025-12-03

---

# **üìÖ SAISON B Semaine 5 √âpisode 3 - Introduction aux ORM**

## **üìö Notions du jour**

Aujourd‚Äôhui, nous avons explor√© un concept **cl√©** pour les applications modernes : les **ORM (Object-Relational Mapping)**. Jusqu‚Äô√† pr√©sent, nous utilisions un **datamapper "manuel"** pour interagir avec notre base de donn√©es. Cependant, cette approche pr√©sente des **limites** :

+ **Code r√©p√©titif** : √âcrire manuellement chaque requ√™te SQL devient fastidieux.
+ **Risque d‚Äôerreurs** : Les requ√™tes SQL mal √©crites peuvent causer des bugs ou des failles de s√©curit√©.
+ **Couplage fort** : Le code est fortement li√© √† la structure de la base de donn√©es.
+ **Maintenance difficile** : Les changements dans la base de donn√©es n√©cessitent des modifications dans tout le code.

Voici les notions aborb√©es durant cette journ√©e :

+ Les limites d‚Äôun *Data Mapper* manuel dans un projet complexe.
+ Le concept d‚Äô**ORM (Object-Relational Mapping)** : un traducteur **Objet <=> SQL**.
+ Pr√©sentation de **Sequelize** comme solution ORM pour Node.js.
+ L‚Äôinstallation des paquets `sequelize` et `pg`.
+ La cr√©ation et la configuration d‚Äôune instance de **Sequelize**.
+ Le test de la connexion √† la base de donn√©es avec `sequelize.authenticate()`.

<!-- more -->

---

Aujourd‚Äôhui, nous avons explor√© un concept **cl√©** pour les applications modernes : les **ORM (Object-Relational Mapping)**. Jusqu‚Äô√† pr√©sent, nous utilisions un **datamapper manuel** pour interagir avec notre base de donn√©es. Cependant, cette approche pr√©sente des **limites** :

+ **Code r√©p√©titif** : √âcrire manuellement chaque requ√™te SQL devient fastidieux.
+ **Risque d‚Äôerreurs** : Les requ√™tes SQL mal √©crites peuvent causer des bugs ou des failles de s√©curit√©.
+ **Couplage fort** : Le code est fortement li√© √† la structure de la base de donn√©es.
+ **Maintenance difficile** : Les changements dans la base de donn√©es n√©cessitent des modifications dans tout le code.

---

### **üîß Qu‚Äôest-ce qu‚Äôun ORM ?**

Un **ORM (Object-Relational Mapping)** est une **biblioth√®que** qui permet de :

+ **Mapper** les tables d‚Äôune base de donn√©es relationnelle (PostgreSQL, MySQL, etc.) √† des **objets JavaScript**.
+ **Automatiser** la g√©n√©ration des requ√™tes SQL (CRUD : Create, Read, Update, Delete).
+ **Abstraire** les d√©tails de la base de donn√©es, ce qui rend le code plus portable.

Un **ORM** comme **Sequelize** agit comme un **traducteur** entre le monde **objet** (JavaScript) et le monde **relationnel** (SQL). Il permet de :

‚úÖ **Manipuler les donn√©es comme des objets** (plus besoin d‚Äô√©crire du SQL manuellement).  
‚úÖ **G√©n√©rer automatiquement les requ√™tes SQL**.  
‚úÖ **G√©rer les relations entre tables** (1:1, 1:N, N:N) de mani√®re intuitive.  
‚úÖ **S√©curiser les requ√™tes** (protection contre les injections SQL).

**Exemple :**
Avec un ORM, au lieu d‚Äô√©crire :

```sql
-- Requ√™te SQL manuelle
INSERT INTO coffees (name, price) VALUES ('Espresso', 2.99);
```

On √©crit :

```javascript
// Avec un ORM (Sequelize)
await Coffee.create({ name: 'Espresso', price: 2.99 });
```

---

### **üí† Pr√©sentation de Sequelize**

[Sequelize](https://sequelize.org/) est un **ORM populaire pour Node.js** qui supporte :

+ **PostgreSQL**, **MySQL**, **SQLite**, **MSSQL**, et **MariaDB**.
+ **Les migrations** pour g√©rer les changements de sch√©ma.
+ **Les relations** entre mod√®les (1:1, 1:N, N:N).
+ **Les transactions** pour garantir l‚Äôint√©grit√© des donn√©es.

---

### **üì¶ Installation et Configuration de Sequelize**

#### **1Ô∏è‚É£ Installer Sequelize et le Driver PostgreSQL**

```bash
npm install sequelize pg pg-hstore
```

+ **`sequelize`** : Le c≈ìur de l‚ÄôORM.
+ **`pg`** : Le driver pour se connecter √† PostgreSQL.
+ **`pg-hstore`** : Pour g√©rer le type de donn√©es `hstore` de PostgreSQL (optionnel).

---

#### **2Ô∏è‚É£ Configurer une Instance de Sequelize**

Cr√©er un fichier `src/database/sequelize.js` pour configurer la connexion √† la base de donn√©es.

```javascript title="database/sequelize.js"
import { Sequelize } from "sequelize";

// Cr√©e l'instance de Sequelize
const sequelize = new Sequelize(process.env.DATABASE_URL, {
  // Define default parameters for Models with option `define: {...}`
  define: {
    // Option to keep the given table name as is
    freezeTableName: true,
    // Option to automatically manage createdAt/updatedAt columns
    timestamps: true,
    // Option that allows automatic generation of fields in snake_case (for exp: createdAt => created_at)
    underscored: true
  }
});

export default sequelize;
```

**Explications :**

+ **`Sequelize`** : Classe principale pour cr√©er une instance de connexion.
+ **`process.env.DATABASE_URL`** : variable d'environnement contenant les param√®tres de connexion √† la BDD.
+ **option `define`** : permet de d√©finir les param√®tres par d√©faut que poss√®deront les *Models* de notre application.

---

#### **3Ô∏è‚É£ Fichier `.env` pour les Variables d‚ÄôEnvironnement**

```plaintext title=".env"
DATABASE_URL=postgres://<user>:<password>@<host>:<port>/<database_name>
```

---

#### **4Ô∏è‚É£ Tester la Connexion √† la Base de Donn√©es**

Avant de commencer √† utiliser Sequelize, il est crucial de **v√©rifier que la connexion √† la base de donn√©es fonctionne**.

```javascript title="database/sequelize.js"
// ... (previous code)

  try {
    await sequelize.authenticate();
    console.log('Connection to the database OK');
  } catch(error) {
    console.error('Connection to the database NOT OK', error);
  }

// To test connexion to DB run: node --env-file=.env database/sequelize-client.js

```

**Explications :**

+ **`sequelize.authenticate()`** : M√©thode pour tester la connexion.
+ Si la connexion r√©ussit, un message de succ√®s s‚Äôaffiche. Sinon, une erreur est logu√©e.

---

### **üìù Cr√©er un Mod√®le avec Sequelize**

Un **mod√®le (***Model***)** dans Sequelize repr√©sente une **table** dans la base de donn√©es. Chaque mod√®le est une **classe** qui √©tend `Model` de Sequelize.

#### **D√©finir un Mod√®le `Coffee`**

```javascript
// src/models/Coffee.js
import { DataTypes } from 'sequelize';
import sequelize from '../database/sequelize.js';

const Coffee = sequelize.define(
  'Coffee', // Model name
  {
    // Model attributes
    name: {
      type: DataTypes.STRING,
      allowNull: false,
      unique: true;
    },
    description: {
      type: DataTypes.TEXT,
    },
    reference: {
      type: DataTypes.CHAR(9),
      allowNull: false,
      unique: true,
    },
    price_per_kg: {
      type: DataTypes.DECIMAL,
      allowNull: false,
    },
    available: {
      type: DataTypes.BOOLEAN,
      allowNull: false,
      defaultValue: false,
    },
  },
  {
    // Model options
    tableName: 'coffees', // Explicit table name
  }
);

export default Coffee;
```

**Explications :**

+ **`sequelize.define()`** : D√©finit un nouveau mod√®le.
    + **Premier argument** : Nom du mod√®le (`Coffee`).
    + **Deuxi√®me argument** : Objet d√©crivant les **colonnes** de la table.
    + **Troisi√®me argument** : Options du mod√®le (ex: `tableName`, `timestamps`).
+ **`DataTypes`** : D√©finit le type de chaque colonne (ex: `STRING`, `INTEGER`, `DECIMAL`).

---

### **üí° Ce Que J‚Äôai Appris Aujourd‚Äôhui**

1. **Un ORM comme Sequelize simplifie l‚Äôinteraction avec une base de donn√©es** en traduisant les objets JavaScript en requ√™tes SQL.
2. **La configuration de Sequelize** est simple et permet de se connecter √† diff√©rentes bases de donn√©es (PostgreSQL, MySQL, etc.).
3. **Les mod√®les Sequelize** repr√©sentent des tables et permettent de d√©finir des colonnes, des types de donn√©es, et des relations.

---

## **‚å®Ô∏è Challenge du jour : "Projet oCoffee" ‚Äì projet fil rouge (suite)**

---

### **‚òïÔ∏è Pr√©sentation du Challenge**

Aujourd‚Äôhui, l‚Äôobjectif √©tait d‚Äô**int√©grer Sequelize** dans notre projet **oCoffee** pour remplacer notre **datamapper manuel**. Sequelize est un **ORM (Object-Relational Mapping)** qui permet de **communiquer avec la base de donn√©es en JavaScript**, sans √©crire de SQL manuellement.

**Pourquoi ?**

+ **Simplifier l‚Äôacc√®s aux donn√©es** : Plus besoin d‚Äô√©crire des requ√™tes SQL √† la main.
+ **Gagner en s√©curit√©** : Sequelize prot√®ge contre les injections SQL et g√®re les connexions √† la base de donn√©es.
+ **Factoriser le code** : Les mod√®les Sequelize permettent de repr√©senter les tables de mani√®re √©l√©gante et r√©utilisable.

**√âtapes √† r√©aliser :**

Reprendre les √©tapes vues en cours pour int√©grer Sequelize √† notre projet d'entra√Ænement oCoffee.

1. Installer les paquets n√©cessaires (`sequelize` et `pg`).
2. Configurer une instance de Sequelize dans un fichier d√©di√© (`sequelize-client.js`).
3. Tester la connexion √† la base de donn√©es.
4. D√©finition du *Model* `Country` sur la base de ce que nous avons fait pour le *Model* `Coffee`.

---

### **üìå √âtapes √† R√©aliser**

Il ne sera pas n√©cessaire ici de pr√©senter √† nouveau les √©tapes r√©alis√©es pour l'int√©gration de Sequelize que j'ai d√©j√† pr√©sent√©es ici üëâ *[int√©gration Sequelize](#1-installer-sequelize-et-le-driver-postgresql)*

---

### **D√©finition du ***Model*** `Country`**

**Objectif :** D√©finir un mod√®le `Country` avec Sequelize, en utilisant la syntaxe `sequelize.define()`.

**Ma proposition :**

```javascript title="src/models/Country.js"
import { DataTypes } from 'sequelize';
import sequelize from '../../database/sequelize-client.js';

const Country = sequelize.define(
  'country',
  {
    name: {
      type: DataTypes.STRING,
      allowNull: false,
      unique: true;
    },
  },
  {
    tableName: 'countries',
  }
);

export default Country;
```

---

### **üí° Ce Que J‚Äôai Appris avec ce Challenge**

1. **Sequelize simplifie la connexion √† une base de donn√©es** en g√©rant les d√©tails techniques.
2. **La configuration de Sequelize** est flexible et permet d‚Äôadapter son comportement (ex: `freezeTableName`, `underscored`).
3. **Tester la connexion** avec `sequelize.authenticate()` est une √©tape cruciale pour s‚Äôassurer que tout fonctionne avant de continuer.
4. **D√©finir des mod√®les** avec `sequelize.define()` permet de repr√©senter les tables de mani√®re claire.
